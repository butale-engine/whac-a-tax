<!DOCTYPE html>
<html lang="sl">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N03FF2ENWZ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-N03FF2ENWZ');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Primary Meta Tags -->
    <title>Kladivo ljudstva - Volitve 2026</title>
    <meta name="title" content="Kladivo ljudstva - Volitve 2026">
    <meta name="description" content="Zgrabi kladivo in poka쬴 politikom, kdo je 코ef! Satiri캜na volilna igra 2026. Brezpla캜no, brez registracije, 100% frustracije!">
    <meta name="keywords" content="volitve 2026, slovenija, igra, satiri캜na igra, politika, kladivo, whac-a-mole">
    <meta name="author" content="Butale Engine">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://igraj.app/">
    <meta property="og:title" content="Kladivo ljudstva - Volitve 2026">
    <meta property="og:description" content="Zgrabi kladivo in poka쬴 politikom, kdo je 코ef! 100% frustracije, 0% davkov.">
    <meta property="og:image" content="https://igraj.app/assets/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="sl_SI">
    <meta property="og:site_name" content="Kladivo ljudstva">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://igraj.app/">
    <meta name="twitter:title" content="Kladivo ljudstva - Volitve 2026">
    <meta name="twitter:description" content="Zgrabi kladivo in poka쬴 politikom, kdo je 코ef! 100% frustracije, 0% davkov.">
    <meta name="twitter:image" content="https://igraj.app/assets/og-image.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
    <meta name="theme-color" content="#005DA4">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }

        canvas {
            display: block;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #header {
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #score-board,
        #timer-board {
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 30px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            backdrop-filter: blur(8px);
            z-index: 10;
        }

        #modal {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        h1 {
            color: #005DA4;
            margin: 0 0 20px 0;
            font-size: 32px;
        }

        p {
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
        }

        button {
            background: linear-gradient(135deg, #005DA4 0%, #004080 100%);
            color: white;
            border: none;
            padding: 15px 32px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px 15px rgba(0, 93, 164, 0.4);
            min-width: 200px;
            min-height: 54px;
            -webkit-tap-highlight-color: transparent;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 93, 164, 0.5);
        }

        button:active {
            transform: translateY(1px);
            background: linear-gradient(135deg, #004080 0%, #003366 100%);
        }

        #combo-display {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            padding: 8px 20px;
            border-radius: 20px;
            color: #333;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        #combo-display.visible {
            opacity: 1;
        }

        #hit-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #4CAF50;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            opacity: 0;
            pointer-events: none;
            transition: none;
        }

        #hit-feedback.quick {
            color: #FFD700;
        }

        @keyframes hitPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -80%) scale(1); opacity: 0; }
        }

        #hit-feedback.show {
            animation: hitPop 0.6s ease-out forwards;
        }

        #hit-message {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            max-width: 80%;
            opacity: 0;
            pointer-events: none;
            border: 2px solid #FFD700;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        @keyframes messageSlide {
            0% { transform: translateX(-50%) translateY(20px); opacity: 0; }
            15% { transform: translateX(-50%) translateY(0); opacity: 1; }
            85% { transform: translateX(-50%) translateY(0); opacity: 1; }
            100% { transform: translateX(-50%) translateY(-10px); opacity: 0; }
        }

        #hit-message.show {
            animation: messageSlide 1.5s ease-out forwards;
        }

        #disclaimer {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            text-align: center;
            pointer-events: none;
        }

        #score-board {
            border-left: 3px solid #005DA4;
        }

        #timer-board {
            border-left: 3px solid #ED1C24;
        }

        #mute-btn {
            background: rgba(0, 0, 0, 0.6);
            border: none;
            padding: 10px 15px;
            border-radius: 30px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        #mute-btn:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        #share-btn {
            background: linear-gradient(135deg, #ED1C24 0%, #C41E24 100%);
            box-shadow: 0 4px 15px rgba(237, 28, 36, 0.4);
            display: none;
        }

        #share-btn:hover {
            box-shadow: 0 6px 20px rgba(237, 28, 36, 0.5);
        }

        #share-btn:active {
            background: linear-gradient(135deg, #C41E24 0%, #A01820 100%);
        }

        #share-btn.visible {
            display: block;
        }

        #download-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            color: #1A1A2E;
            display: none;
        }

        #download-btn:hover {
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
        }

        #download-btn:active {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
        }

        #download-btn.visible {
            display: block;
        }

        #share-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
            pointer-events: none;
        }

        #share-toast.show {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div id="ui-layer">
        <div id="header">
            <div id="score-board">To캜ke: <span id="score-val">0</span></div>
            <div id="timer-board">캛as: <span id="time-val">60</span>s</div>
            <button id="mute-btn">游댉</button>
        </div>
        <div id="combo-display">COMBO x<span id="combo-val">3</span>!</div>
        <div id="hit-feedback">+100</div>
        <div id="hit-message"></div>
        <div id="disclaimer">Nobena kladiva ni bila po코kodovana. Politiki pa...</div>
    </div>

    <div id="overlay">
        <div id="modal">
            <h1 id="title-text">Kladivo ljudstva</h1>
            <p id="desc-text">Zgrabi kladivo in razbij politi캜ne obljube!</p>
            <div class="button-container">
                <button id="download-btn">游닞 Shrani sliko</button>
                <button id="share-btn">Deli rezultat</button>
                <button id="start-btn">Zgrabi kladivo!</button>
            </div>
        </div>
    </div>
    <div id="share-toast">Kladivo kopirano v odlo쬴코캜e!</div>
    <canvas id="score-card" style="display:none;"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Setup scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1A1A2E); // Dark gray from style guide
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // Lights
        const ambientLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        dirLight.shadow.camera.top = 10;
        dirLight.shadow.camera.bottom = -10;
        dirLight.shadow.camera.left = -10;
        dirLight.shadow.camera.right = 10;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        // Board Group
        const boardGroup = new THREE.Group();
        scene.add(boardGroup);

        // Main Green Platform
        const platformGeometry = new THREE.BoxGeometry(11, 1, 11);
        const platformMaterial = new THREE.MeshStandardMaterial({ color: 0x4C9A2A, roughness: 0.8 });
        const platform = new THREE.Mesh(platformGeometry, platformMaterial);
        platform.position.y = -0.5;
        platform.receiveShadow = true;
        boardGroup.add(platform);

        // Politician images - normal and hit versions with funny messages
        const loader = new THREE.TextureLoader();
        const politicians = [
            {
                name: 'golob',
                normal: null,
                hit: null,
                messages: [
                    "Kladivo je na코lo zeleno energijo!",
                    "Svoboda? Evo ti svoboda! *BONK*",
                    "Letalo zamuja, kladivo ne!",
                    "Davki padajo... skupaj s tabo!"
                ]
            },
            {
                name: 'mesec',
                normal: null,
                hit: null,
                messages: [
                    "Redistribucija kladiva!",
                    "Komunizem 0, Kladivo 1!",
                    "Rde캜a zvezda vidi zvezdice!",
                    "Solidarnost? Evo solidaren udarec!"
                ]
            },
            {
                name: 'han',
                normal: null,
                hit: null,
                messages: [
                    "Zamenjal stranko, dobil kladivo!",
                    "Vremenska napoved: Kladivo!",
                    "Han Solo? Han BOLO!",
                    "Koalicija s kladivom!"
                ]
            },
            {
                name: 'logar',
                normal: null,
                hit: null,
                messages: [
                    "Diplomacija kladiva!",
                    "Predsednik kladiva 2026!",
                    "Logar logal, kladivo trkalo!",
                    "NATO kli캜e? Kladivo odgovarja!"
                ]
            },
            {
                name: 'stevanovic',
                normal: null,
                hit: null,
                messages: [
                    "Resnica boli, kladivo tudi!",
                    "Protest? Kladivo protestira nazaj!",
                    "Preiskava zaklju캜ena: KLADIVO!",
                    "Stevanovi캜 u코el, kladivo ga na코lo!"
                ]
            }
        ];

        // Load both normal and hit textures for each politician
        politicians.forEach(p => {
            p.normal = loader.load(`assets/politicians/${p.name}.png`);
            p.hit = loader.load(`assets/politicians/${p.name}-hit.png`);
        });

        // Audio setup
        let audioEnabled = true;
        const sounds = {
            punch1: new Audio('assets/audio/punch1.wav'),
            punch2: new Audio('assets/audio/punch2.wav'),
            popup: new Audio('assets/audio/popup.wav')
        };

        // Preload all sounds
        Object.values(sounds).forEach(sound => {
            sound.load();
            sound.volume = 0.5;
        });

        function playSound(name) {
            if (!audioEnabled || !sounds[name]) return;
            sounds[name].currentTime = 0;
            sounds[name].play().catch(() => {}); // Ignore autoplay errors
        }

        function playHitSound() {
            const punchSounds = ['punch1', 'punch2'];
            const randomPunch = punchSounds[Math.floor(Math.random() * punchSounds.length)];
            playSound(randomPunch);
        }

        // Mute toggle
        const muteBtn = document.getElementById('mute-btn');
        muteBtn.addEventListener('click', () => {
            audioEnabled = !audioEnabled;
            muteBtn.textContent = audioEnabled ? '游댉' : '游댆';
        });

        let currentPoliticianIndex = 0; // Track which politician is currently active

        // Holes and figures
        const figures = [];

        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                const x = i * 3.5;
                const z = j * 3.5;
                const holePos = new THREE.Vector3(x, 0.01, z);

                // Hole Visual
                const holeGeo = new THREE.CircleGeometry(1.2, 32);
                const holeMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 1 });
                const hole = new THREE.Mesh(holeGeo, holeMat);
                hole.rotation.x = -Math.PI / 2;
                hole.position.copy(holePos);
                hole.receiveShadow = true;
                boardGroup.add(hole);

                // Figure
                const figGeo = new THREE.BoxGeometry(2, 2, 0.2);
                const sideMat = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
                const figMat = new THREE.MeshStandardMaterial({
                    map: null,
                    transparent: true,
                    alphaTest: 0.5
                });
                const materials = [sideMat, sideMat, sideMat, sideMat, figMat, sideMat];

                const figure = new THREE.Mesh(figGeo, materials);
                figure.position.set(x, -2, z);
                figure.castShadow = true;
                figure.receiveShadow = true;

                figure.userData = { isUp: false, initialY: -2, targetY: 1, politicianIndex: 0 };
                scene.add(figure);
                figures.push(figure);
            }
        }

        camera.position.set(0, 8, 12);
        camera.lookAt(0, 0, 0);

        // --- Particle System ---
        const particleCount = 50;
        const particleGeometry = new THREE.BufferGeometry();
        const particlePositions = new Float32Array(particleCount * 3);
        particleGeometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));
        const particleMaterial = new THREE.PointsMaterial({
            color: 0xFFFF00,
            size: 0.5,
            transparent: true,
            opacity: 0.8
        });
        const particles = new THREE.Points(particleGeometry, particleMaterial);
        scene.add(particles);

        // Hide initial particles
        for (let i = 0; i < particleCount * 3; i++) particlePositions[i] = 1000;

        let activeParticles = [];

        function spawnParticles(pos) {
            for (let i = 0; i < 20; i++) {
                activeParticles.push({
                    x: pos.x, y: pos.y + 1, z: pos.z,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: Math.random() * 0.5,
                    vz: (Math.random() - 0.5) * 0.5,
                    life: 1.0
                });
            }
        }

        function updateParticles() {
            const positions = particles.geometry.attributes.position.array;
            let pIndex = 0;

            // Clean dead particles first
            for (let i = activeParticles.length - 1; i >= 0; i--) {
                let p = activeParticles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.z += p.vz;
                p.vy -= 0.02; // Gravity
                p.life -= 0.02;

                if (p.life <= 0 || p.y < 0) {
                    activeParticles.splice(i, 1);
                } else {
                    if (pIndex < particleCount) {
                        positions[pIndex * 3] = p.x;
                        positions[pIndex * 3 + 1] = p.y;
                        positions[pIndex * 3 + 2] = p.z;
                        pIndex++;
                    }
                }
            }

            // Clear remaining buffer slots
            for (let j = pIndex; j < particleCount; j++) {
                positions[j * 3] = 1000;
                positions[j * 3 + 1] = 1000;
                positions[j * 3 + 2] = 1000;
            }

            particles.geometry.attributes.position.needsUpdate = true;
        }


        // --- Game Logic ---
        let score = 0;
        let timeLeft = 60;
        let activeFigure = null;
        let popUpTime = 0;      // Track when figure popped up for quick-hit bonus
        let comboCount = 0;     // Track consecutive hits for combo multiplier
        let gameTimerInterval;
        let isGameRunning = false;
        let popUpTimer;

        const scoreElement = document.getElementById('score-val');
        const timeElement = document.getElementById('time-val');
        const overlay = document.getElementById('overlay');
        const startBtn = document.getElementById('start-btn');
        const shareBtn = document.getElementById('share-btn');
        const downloadBtn = document.getElementById('download-btn');
        const scoreCardCanvas = document.getElementById('score-card');
        const shareToast = document.getElementById('share-toast');
        const titleText = document.getElementById('title-text');
        const descText = document.getElementById('desc-text');
        const comboDisplay = document.getElementById('combo-display');
        const comboVal = document.getElementById('combo-val');
        const hitFeedback = document.getElementById('hit-feedback');
        const hitMessage = document.getElementById('hit-message');

        // Show hit feedback animation
        function showHitFeedback(points, isQuickHit) {
            hitFeedback.textContent = '+' + points;
            hitFeedback.className = isQuickHit ? 'quick show' : 'show';
            // Reset animation
            setTimeout(() => {
                hitFeedback.className = '';
            }, 600);
        }

        // Update combo display
        function updateComboDisplay() {
            if (comboCount >= 3) {
                comboVal.textContent = comboCount;
                comboDisplay.classList.add('visible');
            } else {
                comboDisplay.classList.remove('visible');
            }
        }

        // Show funny hit message
        function showHitMessage(politicianIndex) {
            const politician = politicians[politicianIndex];
            const messages = politician.messages;
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            hitMessage.textContent = randomMessage;
            hitMessage.className = 'show';
            setTimeout(() => {
                hitMessage.className = '';
            }, 1500);
        }

        // Score card generation
        function getScoreMessage(finalScore) {
            if (finalScore >= 3000) return "Thor ti zavid치! Mojster kladiva!";
            if (finalScore >= 2000) return "Kladivo ljudstva te imenuje za ministra!";
            if (finalScore >= 1000) return "Solidno kladivo! Politiki te 쬰 sovra쬴jo!";
            if (finalScore >= 500) return "Kladivo je 코e hladno, gremo dalje!";
            return "Politiki so zmagali... TO JE NESPREJEMLJIVO!";
        }

        function generateScoreCard(finalScore) {
            const canvas = scoreCardCanvas;
            const ctx = canvas.getContext('2d');

            // Instagram Stories format (9:16)
            canvas.width = 1080;
            canvas.height = 1920;

            // Background gradient (Slovenian colors)
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#005DA4');
            gradient.addColorStop(0.5, '#1A1A2E');
            gradient.addColorStop(1, '#1A1A2E');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Decorative elements - Slovenian flag colors (white, blue, red)
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, 20);
            ctx.fillStyle = '#005DA4';
            ctx.fillRect(0, 20, canvas.width, 20);
            ctx.fillStyle = '#ED1C24';
            ctx.fillRect(0, 40, canvas.width, 20);

            // Game title
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 64px system-ui, -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Volitve 2026:', canvas.width / 2, 250);
            ctx.font = 'bold 72px system-ui, -apple-system, sans-serif';
            ctx.fillText('Kladivo ljudstva', canvas.width / 2, 340);

            // Score circle background
            ctx.beginPath();
            ctx.arc(canvas.width / 2, 700, 220, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 215, 0, 0.15)';
            ctx.fill();
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 8;
            ctx.stroke();

            // Score number
            ctx.font = 'bold 180px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = '#FFD700';
            ctx.fillText(finalScore.toString(), canvas.width / 2, 750);

            // "to캜k" label
            ctx.font = '48px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText('to캜k', canvas.width / 2, 830);

            // Satirical message based on score
            const message = getScoreMessage(finalScore);
            ctx.font = 'italic 42px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = '#B0B0B0';
            ctx.fillText(message, canvas.width / 2, 1050);

            // Call to action
            ctx.font = 'bold 36px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText('Ima코 dovolj mo캜no kladivo?', canvas.width / 2, 1200);

            // URL box
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            roundRect(ctx, 140, 1350, 800, 80, 40);
            ctx.fill();

            ctx.font = '32px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = '#B0B0B0';
            ctx.fillText('igraj.app', canvas.width / 2, 1405);

            // Disclaimer
            ctx.font = '24px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = '#666666';
            ctx.fillText('Nobena kladiva ni bila po코kodovana. Politiki pa...', canvas.width / 2, 1800);

            return canvas.toDataURL('image/png');
        }

        // Helper function for rounded rectangles
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        function downloadScoreCard() {
            // Track download action
            gtag('event', 'download', {
                'event_category': 'engagement',
                'event_label': 'score_card',
                'value': score
            });

            const dataUrl = generateScoreCard(score);
            const link = document.createElement('a');
            link.download = `kladivo-ljudstva-${score}-tock.png`;
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Kladivo fotografirano!');
        }

        // Show toast notification
        function showToast(message) {
            shareToast.textContent = message;
            shareToast.classList.add('show');
            setTimeout(() => {
                shareToast.classList.remove('show');
            }, 2000);
        }

        // Share result using Web Share API or clipboard fallback
        async function shareResult() {
            // Track share action
            gtag('event', 'share', {
                'event_category': 'engagement',
                'event_label': 'score_share',
                'value': score
            });

            const shareText = `Moje kladivo je razbilo ${score} to캜k! Tvoje kladivo je verjetno iz kartona. Doka쬴 nasprotno!`;
            const shareUrl = window.location.href;

            // Try Web Share API first (works on mobile)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Kladivo ljudstva - Volitve 2026',
                        text: shareText,
                        url: shareUrl
                    });
                    return;
                } catch (err) {
                    // User cancelled or error - fall through to clipboard
                    if (err.name === 'AbortError') return;
                }
            }

            // Fallback: copy to clipboard
            const fullText = `${shareText}\n${shareUrl}`;
            try {
                await navigator.clipboard.writeText(fullText);
                showToast('Rezultat kopiran!');
            } catch (err) {
                // Final fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = fullText;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Rezultat kopiran!');
            }
        }

        function startGame() {
            // Track game start
            gtag('event', 'game_start', { 'event_category': 'game' });

            score = 0;
            timeLeft = 60;
            comboCount = 0;
            scoreElement.innerText = score;
            timeElement.innerText = timeLeft;
            isGameRunning = true;
            comboDisplay.classList.remove('visible');
            shareBtn.classList.remove('visible');
            downloadBtn.classList.remove('visible');

            overlay.style.display = 'none';

            // Start Loop
            // Cancel any pending popups
            if (popUpTimer) clearTimeout(popUpTimer);
            if (activeFigure) {
                moveFigure(activeFigure, activeFigure.userData.initialY);
                activeFigure = null;
            }

            scheduleNextPop();

            if (gameTimerInterval) clearInterval(gameTimerInterval);
            gameTimerInterval = setInterval(() => {
                timeLeft--;
                timeElement.textContent = timeLeft;
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            // Track game completion with score
            gtag('event', 'game_complete', {
                'event_category': 'game',
                'value': score
            });

            isGameRunning = false;
            clearInterval(gameTimerInterval);
            if (popUpTimer) clearTimeout(popUpTimer);
            if (activeFigure) {
                moveFigure(activeFigure, activeFigure.userData.initialY);
                activeFigure = null;
            }

            titleText.innerText = "Kladivo po캜iva!";
            descText.innerText = `Razbil/a si ${score} politi캜nih obljub!`;
            startBtn.innerText = "만 enkrat razbijaj!";
            shareBtn.classList.add('visible');
            downloadBtn.classList.add('visible');
            overlay.style.display = 'flex';
        }



        function scheduleNextPop() {
            if (!isGameRunning) return;

            // Difficulty scaling: faster as score increases
            let delay = 1500 - (score * 30);
            if (delay < 600) delay = 600;

            popUpTimer = setTimeout(() => {
                popUp();
                scheduleNextPop();
            }, delay);
        }

        // Animation / Tweening helper
        function moveFigure(figure, targetY, duration = 300) {
            const startY = figure.position.y;
            const startTime = performance.now();

            function animateMove(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);
                figure.position.y = startY + (targetY - startY) * ease;
                if (progress < 1) requestAnimationFrame(animateMove);
            }
            requestAnimationFrame(animateMove);
        }

        function popUp() {
            if (!isGameRunning) return;

            if (activeFigure) {
                activeFigure.userData.isUp = false;
                moveFigure(activeFigure, activeFigure.userData.initialY);
                activeFigure = null;
            }

            const index = Math.floor(Math.random() * figures.length);
            const figure = figures[index];

            // Select random politician and show normal texture
            const politicianIndex = Math.floor(Math.random() * politicians.length);
            figure.userData.politicianIndex = politicianIndex;
            figure.material[4].map = politicians[politicianIndex].normal;
            figure.material[4].needsUpdate = true;

            activeFigure = figure;
            activeFigure.userData.isUp = true;
            popUpTime = performance.now(); // Track when figure appeared

            moveFigure(activeFigure, activeFigure.userData.targetY);
            playSound('popup');

            const currentActive = activeFigure;

            // Stay up duration
            let stayDuration = 1000 - (score * 10);
            if (stayDuration < 500) stayDuration = 500;

            setTimeout(() => {
                if (activeFigure === currentActive && activeFigure) {
                    activeFigure.userData.isUp = false;
                    moveFigure(activeFigure, activeFigure.userData.initialY);
                    activeFigure = null;
                    // Reset combo on miss (figure went down without being hit)
                    comboCount = 0;
                    updateComboDisplay();
                }
            }, stayDuration);
        }

        // Raycaster
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        function onMouseDown(event) {
            // Only interact if game running and not clicking overlay UI (which has higher z-index anyway, but good to check)
            if (!isGameRunning) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(figures);

            if (intersects.length > 0) {
                const hitFigure = intersects[0].object;
                if (hitFigure === activeFigure && hitFigure.userData.isUp) {
                    // Calculate reaction time for quick-hit bonus
                    const reactionTime = performance.now() - popUpTime;
                    const isQuickHit = reactionTime < 500;

                    // Base points: 100 normal, 150 for quick hit
                    let points = isQuickHit ? 150 : 100;

                    // Increment combo counter
                    comboCount++;

                    // Apply 1.5x multiplier for 3+ consecutive hits
                    if (comboCount >= 3) {
                        points = Math.floor(points * 1.5);
                    }

                    score += points;
                    scoreElement.innerText = score;

                    // Visual feedback
                    const pIndex = hitFigure.userData.politicianIndex;
                    showHitFeedback(points, isQuickHit);
                    showHitMessage(pIndex);
                    updateComboDisplay();

                    // Swap to hit texture
                    hitFigure.material[4].map = politicians[pIndex].hit;
                    hitFigure.material[4].needsUpdate = true;

                    // FX
                    playHitSound();
                    spawnParticles(hitFigure.position);

                    // Logic - brief delay to show hit texture before going down
                    hitFigure.userData.isUp = false;
                    setTimeout(() => {
                        moveFigure(hitFigure, hitFigure.userData.initialY, 100);
                    }, 150);
                    activeFigure = null;

                    // Immediate next pop? Or wait for schedule.
                    // Let's reset schedule to keep pace fast
                    if (popUpTimer) clearTimeout(popUpTimer);
                    scheduleNextPop();
                }
            }
        }

        startBtn.addEventListener('click', startGame);
        shareBtn.addEventListener('click', shareResult);
        downloadBtn.addEventListener('click', downloadScoreCard);

        // Handle both mouse and touch events
        function onTouchStart(event) {
            if (!isGameRunning) return;
            event.preventDefault();
            const touch = event.touches[0];
            mouse.x = (touch.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(touch.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(figures);

            if (intersects.length > 0) {
                const hitFigure = intersects[0].object;
                if (hitFigure === activeFigure && hitFigure.userData.isUp) {
                    // Calculate reaction time for quick-hit bonus
                    const reactionTime = performance.now() - popUpTime;
                    const isQuickHit = reactionTime < 500;

                    // Base points: 100 normal, 150 for quick hit
                    let points = isQuickHit ? 150 : 100;

                    // Increment combo counter
                    comboCount++;

                    // Apply 1.5x multiplier for 3+ consecutive hits
                    if (comboCount >= 3) {
                        points = Math.floor(points * 1.5);
                    }

                    score += points;
                    scoreElement.innerText = score;

                    // Visual feedback
                    const pIndex = hitFigure.userData.politicianIndex;
                    showHitFeedback(points, isQuickHit);
                    showHitMessage(pIndex);
                    updateComboDisplay();

                    // Swap to hit texture
                    hitFigure.material[4].map = politicians[pIndex].hit;
                    hitFigure.material[4].needsUpdate = true;

                    // FX
                    playHitSound();
                    spawnParticles(hitFigure.position);

                    // Logic - brief delay to show hit texture before going down
                    hitFigure.userData.isUp = false;
                    setTimeout(() => {
                        moveFigure(hitFigure, hitFigure.userData.initialY, 100);
                    }, 150);
                    activeFigure = null;

                    // Reset schedule to keep pace fast
                    if (popUpTimer) clearTimeout(popUpTimer);
                    scheduleNextPop();
                }
            }
        }

        window.addEventListener('mousedown', onMouseDown);
        window.addEventListener('touchstart', onTouchStart, { passive: false });
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Loop
        function animate() {
            requestAnimationFrame(animate);
            updateParticles();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>

</html>